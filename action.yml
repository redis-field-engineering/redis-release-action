name: 'Redis Release Action'
description: 'Composite GitHub action for releasing Redis projects'
inputs:
  gpg-key-id:
    description: "GPG Key ID"
    required: true
  gpg-secret-key:
    description: "GPG secret key"
    required: true
  gpg-public-key:
    description: "GPG public key"
    required: true
  gpg-passphrase:
    description: "GPG passphrase"
    required: true
  sonatype-username:
    description: "Sonatype username"
    required: true
  sonatype-password:
    description: "Sonatype password"
    required: true
  github-token:
    description: "GitHub Personal Access Token"
    required: true
  slack-webhook:
    description: "Slack webhook URL"
    required: true
  codecov-token:
    description: "Upload token for codecov.io"
    required: false
  docker-password:
    description: "Docker registry password"
    required: false

runs:
  using: "composite"
  steps:
    - name: Version
      id: vars
      run: echo ::set-output name=version::$(cat VERSION)
      shell: bash

    - name: Build
      uses: redis-field-engineering/redis-build-action@v1
      with:
        release: true
        codecov-token: ${{ inputs.codecov-token }}

    - name: Deploy
      env:
        GITHUB_USERNAME: jruaux
        GPG_KEY_ID: ${{ inputs.gpg-key-id }}
        GPG_SECRET_KEY: ${{ inputs.gpg-secret-key }}
        GPG_PASSPHRASE: ${{ inputs.gpg-passphrase }}
      run: |
        ./gradlew -Prelease=true -Pfull-release=true \
        -PsonatypeUsername=${{ inputs.sonatype-username }} \
        -PsonatypePassword=${{ inputs.sonatype-password }} \
        publishToSonatype closeAndReleaseSonatypeStagingRepository -S
      shell: bash

    - name: Assemble
      uses: jreleaser/release-action@v1
      with:
        arguments: assemble
      env:
        JRELEASER_PROJECT_VERSION: ${{ steps.vars.outputs.version }}
        JRELEASER_GITHUB_TOKEN: ${{ inputs.github-token }}

    - name: Release
      uses: jreleaser/release-action@v1
      with:
        arguments: full-release
      env:
        JRELEASER_PROJECT_VERSION: ${{ steps.vars.outputs.version }}
        JRELEASER_GITHUB_TOKEN: ${{ inputs.github-token }}
        JRELEASER_GPG_PASSPHRASE: ${{ inputs.gpg-passphrase }}
        JRELEASER_GPG_PUBLIC_KEY: ${{ inputs.gpg-public-key }}
        JRELEASER_GPG_SECRET_KEY: ${{ inputs.gpg-secret-key }}
        JRELEASER_SLACK_WEBHOOK: ${{ inputs.slack-webhook }}
        JRELEASER_DOCKER_DEFAULT_PASSWORD: ${{ inputs.docker-password }}

    - name: JReleaser output
      uses: actions/upload-artifact@v2
      with:
        name: artifact
        path: |
          out/jreleaser/trace.log
          out/jreleaser/output.properties